{% extends "base.html" %}
{% load static %}

{% block title %}マイページ{% endblock %}

{% block content %}
<div class="container mt-5" style="max-width: 600px;">
    <h2 class="mb-4 text-center">マイページ</h2>

    <div class="border rounded p-4 mb-4 bg-light">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} text-center">{{ message }}</div>
            {% endfor %}
        {% endif %}

        <form method="post" novalidate>
            {% csrf_token %}

            <!-- ユーザー情報 -->
            <h5 class="text-center">ユーザー情報</h5>
            {% for field in user_form %}
                <div class="mb-3 d-flex flex-column align-items-center">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}<div class="text-danger small">{{ field.errors|striptags }}</div>{% endif %}
                </div>
            {% endfor %}

            <!-- パスワード設定 -->
            <div class="mb-4">
                <button class="btn btn-link d-block mx-auto text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#passwordForm" aria-expanded="false" aria-controls="passwordForm">
                    新しいパスワードを設定
                </button>
                <div class="collapse" id="passwordForm">
                    {% for field in password_form %}
                        <div class="mb-3 d-flex flex-column align-items-center">
                            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}<div class="text-danger small">{{ field.errors|striptags }}</div>{% endif %}
                        </div>
                    {% endfor %}
                    <div class="text-center">
                        <button type="submit" name="save_password" class="btn btn-outline-secondary btn-sm">パスワードを保存</button>
                    </div>
                </div>
            </div>

            <!-- 住所 -->
            <h5 class="text-center">住所</h5>
            <label class="form-label small text-center w-100">住所を選択</label>
            <select class="form-select form-select-sm mb-3" id="address-select" style="text-align: center; text-align-last: center">
                {% for address in addresses %}
                    <option value="{{ address.id }}">{{ address.postal_code }} {{ address.prefecture }} {{ address.city }} {{ address.detail }}</option>
                {% endfor %}
            </select>
            {% for field in address_form %}
                <div class="mb-3 d-flex flex-column align-items-center">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}<div class="text-danger small">{{ field.errors|striptags }}</div>{% endif %}
                </div>
            {% endfor %}

            <!-- この住所をデフォルトに設定 -->
            <div class="form-check mb-3 d-flex justify-content-center">
                <input class="form-check-input" type="checkbox" id="id_is_default" name="is_default">
                <label class="form-check-label ms-2" for="id_is_default">この住所を配送先に設定</label>
            </div>

            <!-- 新しい住所追加 -->
            <div class="mb-4">
                <button class="btn btn-link d-block mx-auto text-muted" type="button" data-bs-toggle="collapse" data-bs-target="#newAddressForm" aria-expanded="false" aria-controls="newAddressForm">
                    新しい住所を追加
                </button>
                <div class="collapse" id="newAddressForm">
                    {% for field in new_address_form %}
                        <div class="mb-3 d-flex flex-column align-items-center">
                            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}<div class="text-danger small">{{ field.errors|striptags }}</div>{% endif %}
                        </div>
                    {% endfor %}

                    <!-- 新住所をデフォルトに設定 -->
                    <div class="form-check mb-3 d-flex justify-content-center">
                        <input class="form-check-input" type="checkbox" id="id_new_is_default" name="new_is_default">
                        <label class="form-check-label ms-2" for="id_new_is_default">この住所を配送先に設定</label>
                    </div>

                    <div class="text-center">
                        <button type="submit" name="save_new_address" class="btn btn-outline-secondary btn-sm">新しい住所を保存</button>
                    </div>
                </div>
            </div>

            <!-- 一括更新 -->
            <div class="text-center mt-4">
                <button type="submit" name="update_all" class="btn btn-primary">更新</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts_extra %}
<script>
    // ビューから渡されたJSONデータをJavaScript変数に格納
    const allAddressesData = JSON.parse('{{ addresses_json|safe }}');

    document.addEventListener('DOMContentLoaded', function() {
        const addressSelect = document.getElementById('address-select');
        if (!addressSelect) {
            return; // 要素が見つからなければ処理を中断
        }
        
        // 住所フォームの各フィールド要素を取得（Djangoが生成するIDを使用）
        // これらのIDはDjangoのforms.pyで定義されたフィールド名に基づきます
        const postalCodeField = document.getElementById('id_postal_code');
        const prefectureField = document.getElementById('id_prefecture');
        const cityField = document.getElementById('id_city');
        const streetField = document.getElementById('id_street');
        const buildingField = document.getElementById('id_building');
        // 他の住所フィールドがあればここに追加してください

        // フォームフィールドを更新するヘルパー関数
        function updateAddressFormFields(address) {
            if (postalCodeField) postalCodeField.value = address ? (address.postal_code || '') : '';
            if (prefectureField) prefectureField.value = address ? (address.prefecture || '') : '';
            if (cityField) cityField.value = address ? (address.city || '') : '';
            if (streetField) streetField.value = address ? (address.street || '') : '';
            if (buildingField) buildingField.value = address ? (address.building || '') : '';
        }

        // ドロップダウンの変更イベントをリッスン
        addressSelect.addEventListener('change', function() {
            const selectedAddressId = this.value; // 選択されたoptionのvalue（住所ID）を取得

            if (selectedAddressId) {
                // allAddressesDataから選択された住所オブジェクトを検索
                const selectedAddress = allAddressesData.find(addr => String(addr.id) === String(selectedAddressId)); // IDの型を合わせる
                
                if (selectedAddress) {
                    updateAddressFormFields(selectedAddress);
                } else {
                    updateAddressFormFields(null); // 見つからなければフォームをクリア
                }
            } else {
                // 「--- 住所を選択してください ---」が選択された場合、フォームをクリア
                updateAddressFormFields(null);
            }
        });

        const initialSelectedId = addressSelect.value;
        if (initialSelectedId) {
            const initialAddress = allAddressesData.find(addr => String(addr.id) === String(initialSelectedId));
            if (initialAddress) {
                updateAddressFormFields(initialAddress);
            }
        }

        const existingCheckbox = document.getElementById('id_is_default');
        const newCheckbox = document.getElementById('id_new_is_default');

        if (existingCheckbox && newCheckbox) {
            existingCheckbox.addEventListener('change', function () {
                if (this.checked) {
                    newCheckbox.checked = false;
                }
            });

            newCheckbox.addEventListener('change', function () {
                if (this.checked) {
                    existingCheckbox.checked = false;
                }
            });
        }
    });
</script>
{% endblock scripts_extra %}
